<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>FFI | Enqueue Zero</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Enqueue Zero is publishing code principles.">
    
    <link rel="preload" href="/assets/css/0.styles.472f46d1.css" as="style"><link rel="preload" href="/assets/js/app.26662bcd.js" as="script"><link rel="preload" href="/assets/js/6.d2240214.js" as="script"><link rel="preload" href="/assets/js/89.2b92f963.js" as="script"><link rel="prefetch" href="/assets/js/1.f7157d85.js"><link rel="prefetch" href="/assets/js/10.bb89159d.js"><link rel="prefetch" href="/assets/js/100.696fc0f0.js"><link rel="prefetch" href="/assets/js/101.a1c3f849.js"><link rel="prefetch" href="/assets/js/102.bfa743be.js"><link rel="prefetch" href="/assets/js/103.694af51d.js"><link rel="prefetch" href="/assets/js/104.c21c3757.js"><link rel="prefetch" href="/assets/js/105.d5841585.js"><link rel="prefetch" href="/assets/js/106.9cf7fa00.js"><link rel="prefetch" href="/assets/js/107.1ec93d70.js"><link rel="prefetch" href="/assets/js/108.0b8763b2.js"><link rel="prefetch" href="/assets/js/109.e7196d2e.js"><link rel="prefetch" href="/assets/js/11.e30c030f.js"><link rel="prefetch" href="/assets/js/110.a6dd1b2d.js"><link rel="prefetch" href="/assets/js/111.77cce519.js"><link rel="prefetch" href="/assets/js/112.70165eb2.js"><link rel="prefetch" href="/assets/js/113.3fa50ee2.js"><link rel="prefetch" href="/assets/js/114.31c8c10f.js"><link rel="prefetch" href="/assets/js/115.af04f95c.js"><link rel="prefetch" href="/assets/js/116.457c2566.js"><link rel="prefetch" href="/assets/js/117.c43e188a.js"><link rel="prefetch" href="/assets/js/118.8cf2c53e.js"><link rel="prefetch" href="/assets/js/119.bd688ff9.js"><link rel="prefetch" href="/assets/js/12.3e81efff.js"><link rel="prefetch" href="/assets/js/120.dc1164f5.js"><link rel="prefetch" href="/assets/js/121.f8bd20ba.js"><link rel="prefetch" href="/assets/js/122.58c1b292.js"><link rel="prefetch" href="/assets/js/123.3ab17f6c.js"><link rel="prefetch" href="/assets/js/124.79a8fefc.js"><link rel="prefetch" href="/assets/js/125.bb87430b.js"><link rel="prefetch" href="/assets/js/126.de1343ef.js"><link rel="prefetch" href="/assets/js/127.d66cf797.js"><link rel="prefetch" href="/assets/js/128.c2ce57e8.js"><link rel="prefetch" href="/assets/js/129.e0515a98.js"><link rel="prefetch" href="/assets/js/13.3ae4e3c9.js"><link rel="prefetch" href="/assets/js/130.b198674a.js"><link rel="prefetch" href="/assets/js/131.b44003aa.js"><link rel="prefetch" href="/assets/js/132.9ce0efcd.js"><link rel="prefetch" href="/assets/js/133.c5ff5656.js"><link rel="prefetch" href="/assets/js/134.27dfad96.js"><link rel="prefetch" href="/assets/js/135.1a6c5976.js"><link rel="prefetch" href="/assets/js/136.a40474aa.js"><link rel="prefetch" href="/assets/js/137.337a587b.js"><link rel="prefetch" href="/assets/js/138.c0a1d2f5.js"><link rel="prefetch" href="/assets/js/139.789324e5.js"><link rel="prefetch" href="/assets/js/14.6745f1f0.js"><link rel="prefetch" href="/assets/js/140.0f6046b7.js"><link rel="prefetch" href="/assets/js/141.ca8677a9.js"><link rel="prefetch" href="/assets/js/142.7cd41612.js"><link rel="prefetch" href="/assets/js/143.4e06cdc6.js"><link rel="prefetch" href="/assets/js/144.30a011d9.js"><link rel="prefetch" href="/assets/js/145.616e4d0c.js"><link rel="prefetch" href="/assets/js/146.9f8b8212.js"><link rel="prefetch" href="/assets/js/147.aa478e29.js"><link rel="prefetch" href="/assets/js/148.3114d5cd.js"><link rel="prefetch" href="/assets/js/149.f8711773.js"><link rel="prefetch" href="/assets/js/15.2f559067.js"><link rel="prefetch" href="/assets/js/150.66da4609.js"><link rel="prefetch" href="/assets/js/151.9a722cf9.js"><link rel="prefetch" href="/assets/js/152.c625b811.js"><link rel="prefetch" href="/assets/js/153.6f67989f.js"><link rel="prefetch" href="/assets/js/154.8d3771fd.js"><link rel="prefetch" href="/assets/js/155.db2eb76a.js"><link rel="prefetch" href="/assets/js/156.d5dd02f5.js"><link rel="prefetch" href="/assets/js/157.12f4dc82.js"><link rel="prefetch" href="/assets/js/158.106505d8.js"><link rel="prefetch" href="/assets/js/159.a2dbf072.js"><link rel="prefetch" href="/assets/js/16.b9adde67.js"><link rel="prefetch" href="/assets/js/160.3145ef30.js"><link rel="prefetch" href="/assets/js/161.25da45f5.js"><link rel="prefetch" href="/assets/js/162.a65448a4.js"><link rel="prefetch" href="/assets/js/163.f07fa25d.js"><link rel="prefetch" href="/assets/js/164.467c6d5c.js"><link rel="prefetch" href="/assets/js/17.01834c30.js"><link rel="prefetch" href="/assets/js/18.9956aed9.js"><link rel="prefetch" href="/assets/js/19.d99e88b1.js"><link rel="prefetch" href="/assets/js/2.0d8a973f.js"><link rel="prefetch" href="/assets/js/20.8ce58444.js"><link rel="prefetch" href="/assets/js/21.8e95e990.js"><link rel="prefetch" href="/assets/js/22.46dc304c.js"><link rel="prefetch" href="/assets/js/23.1ad9ea02.js"><link rel="prefetch" href="/assets/js/24.32437043.js"><link rel="prefetch" href="/assets/js/25.e3764fbe.js"><link rel="prefetch" href="/assets/js/26.e4eec541.js"><link rel="prefetch" href="/assets/js/27.54c6db2e.js"><link rel="prefetch" href="/assets/js/28.8dc6cb87.js"><link rel="prefetch" href="/assets/js/29.4d3624fc.js"><link rel="prefetch" href="/assets/js/3.dd706b41.js"><link rel="prefetch" href="/assets/js/30.c4d8ab26.js"><link rel="prefetch" href="/assets/js/31.d28673cb.js"><link rel="prefetch" href="/assets/js/32.51d979f3.js"><link rel="prefetch" href="/assets/js/33.7359ba2a.js"><link rel="prefetch" href="/assets/js/34.c3f19c8f.js"><link rel="prefetch" href="/assets/js/35.1613123f.js"><link rel="prefetch" href="/assets/js/36.5a82821a.js"><link rel="prefetch" href="/assets/js/37.b95059f5.js"><link rel="prefetch" href="/assets/js/38.67082dba.js"><link rel="prefetch" href="/assets/js/39.f9e197d7.js"><link rel="prefetch" href="/assets/js/4.29da6077.js"><link rel="prefetch" href="/assets/js/40.309fa7cc.js"><link rel="prefetch" href="/assets/js/41.12e2904c.js"><link rel="prefetch" href="/assets/js/42.60c54b7c.js"><link rel="prefetch" href="/assets/js/43.93d5d55c.js"><link rel="prefetch" href="/assets/js/44.c7972aa3.js"><link rel="prefetch" href="/assets/js/45.0e7f822e.js"><link rel="prefetch" href="/assets/js/46.6646cc92.js"><link rel="prefetch" href="/assets/js/47.ef2ff153.js"><link rel="prefetch" href="/assets/js/48.aba7bfcd.js"><link rel="prefetch" href="/assets/js/49.76ce0dd5.js"><link rel="prefetch" href="/assets/js/50.bfd5ce8a.js"><link rel="prefetch" href="/assets/js/51.78e9f09c.js"><link rel="prefetch" href="/assets/js/52.d84bf105.js"><link rel="prefetch" href="/assets/js/53.63ae3ba7.js"><link rel="prefetch" href="/assets/js/54.c13091c1.js"><link rel="prefetch" href="/assets/js/55.0fd04d7d.js"><link rel="prefetch" href="/assets/js/56.30c3e036.js"><link rel="prefetch" href="/assets/js/57.88f684ac.js"><link rel="prefetch" href="/assets/js/58.b0273999.js"><link rel="prefetch" href="/assets/js/59.2bd4017a.js"><link rel="prefetch" href="/assets/js/60.cb5e31cd.js"><link rel="prefetch" href="/assets/js/61.78c24020.js"><link rel="prefetch" href="/assets/js/62.ed7bb122.js"><link rel="prefetch" href="/assets/js/63.6dc67c03.js"><link rel="prefetch" href="/assets/js/64.ba48b753.js"><link rel="prefetch" href="/assets/js/65.95fb6a85.js"><link rel="prefetch" href="/assets/js/66.cf7b0f4b.js"><link rel="prefetch" href="/assets/js/67.135e02b9.js"><link rel="prefetch" href="/assets/js/68.692785cb.js"><link rel="prefetch" href="/assets/js/69.71acc6d9.js"><link rel="prefetch" href="/assets/js/7.e6dfaa84.js"><link rel="prefetch" href="/assets/js/70.9330fa95.js"><link rel="prefetch" href="/assets/js/71.323daa7b.js"><link rel="prefetch" href="/assets/js/72.0a1f652c.js"><link rel="prefetch" href="/assets/js/73.58f8d79d.js"><link rel="prefetch" href="/assets/js/74.c79161f6.js"><link rel="prefetch" href="/assets/js/75.ebdc4060.js"><link rel="prefetch" href="/assets/js/76.d7c6a683.js"><link rel="prefetch" href="/assets/js/77.1c74ae52.js"><link rel="prefetch" href="/assets/js/78.1435c08f.js"><link rel="prefetch" href="/assets/js/79.550e023e.js"><link rel="prefetch" href="/assets/js/8.9d730b63.js"><link rel="prefetch" href="/assets/js/80.0fcde753.js"><link rel="prefetch" href="/assets/js/81.54ad9ad6.js"><link rel="prefetch" href="/assets/js/82.106f6213.js"><link rel="prefetch" href="/assets/js/83.eb1f77af.js"><link rel="prefetch" href="/assets/js/84.dc27d377.js"><link rel="prefetch" href="/assets/js/85.952de193.js"><link rel="prefetch" href="/assets/js/86.849ef641.js"><link rel="prefetch" href="/assets/js/87.ba839e63.js"><link rel="prefetch" href="/assets/js/88.55c67120.js"><link rel="prefetch" href="/assets/js/9.4f13d7d8.js"><link rel="prefetch" href="/assets/js/90.599d1ee9.js"><link rel="prefetch" href="/assets/js/91.ca49947d.js"><link rel="prefetch" href="/assets/js/92.fee804a1.js"><link rel="prefetch" href="/assets/js/93.38edda54.js"><link rel="prefetch" href="/assets/js/94.2a5af489.js"><link rel="prefetch" href="/assets/js/95.694d7882.js"><link rel="prefetch" href="/assets/js/96.dbae4a47.js"><link rel="prefetch" href="/assets/js/97.f635273c.js"><link rel="prefetch" href="/assets/js/98.4b13da17.js"><link rel="prefetch" href="/assets/js/99.1c228ad5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.472f46d1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Enqueue Zero</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/soasme/enqueuezero" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/soasme/enqueuezero" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ffi"><a href="#ffi" class="header-anchor">#</a> FFI</h1> <p></p><div class="table-of-contents"><ul><li><a href="#context">Context</a></li><li><a href="#overview">Overview</a></li><li><a href="#solutions">Solutions</a><ul><li><a href="#luajit-ffi">LuaJit - FFI</a></li><li><a href="#common-lisp-ffi">Common Lisp - FFI</a></li><li><a href="#pony-ffi">Pony - FFI</a></li><li><a href="#c-libffi">C - libffi</a></li></ul></li><li><a href="#patterns">Patterns</a><ul><li><a href="#how-it-works">How it works</a></li><li><a href="#abi-v-s-api">ABI v/s API</a></li><li><a href="#type-conversion">Type Conversion</a></li><li><a href="#c-headers-copy-n-paste-v-s-semantic-signature">C Headers Copy-n-Paste v/s Semantic Signature</a></li><li><a href="#alignment-in-32-bit-v-s-64-bit">!!! Alignment in 32-bit v/s 64-bit</a></li><li><a href="#long-long">Long Long</a></li><li><a href="#callback">Callback</a></li><li><a href="#garbage-collect">Garbage Collect</a></li><li><a href="#thread-safe-v-s-thread-unsafe">Thread-safe v/s Thread-unsafe</a></li><li><a href="#advantage-and-disadvantage">Advantage and Disadvantage</a></li></ul></li><li><a href="#conclusions">Conclusions</a></li><li><a href="#references">References</a></li></ul></div><p></p> <h2 id="context"><a href="#context" class="header-anchor">#</a> Context</h2> <p>C function parameter types and return type are nowhere in compiled shared dynamic library. Some other programs may not know what arguments are to be passed to a function in this program.</p> <p>In Python, we can dynamically load a dynamic library, resolve FuncPointers by symbols of functions and even call it. The only problem is that the program would crash without the right parameters passing into functions.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> ctypes
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">'libc.dylib'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> libc<span class="token punctuation">.</span>atoi
<span class="token operator">&lt;</span>_FuncPtr <span class="token builtin">object</span> at <span class="token number">0x100a509a8</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> libc<span class="token punctuation">.</span>atoi<span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> libc<span class="token punctuation">.</span>atoi<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    <span class="token number">47162</span> segmentation fault  python
</code></pre></div><p>The reason is simple. Everything in the dynamic library is machine instruction. We have registers like <code>%esi</code>, <code>%xmm0</code> in dynamic library, but no <code>const point_t* p1, const point_t* p2</code> at all.</p> <p>[img[ffi-after-dlopen.jpg]]</p> <p>It's easy to know such information in C by sharing header file definition, but calling it in another language might seems a big challenge.</p> <p>FFI is a technology that solved this problem.</p> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>FFI, or Foreign Function Interface, allows code written in one language to call code written in another language. The major use case is for dynamic VM languages calling dynamic libraries. For example, Python has CFFI or ctypes, same as Ruby, Java, Lua using it in similar C FFI libraries.</p> <p>Basically after dynamically loaded and resolved symbols in <code>.so</code> or <code>.ddl</code> file, we use FFI constructing foreign function call.</p> <p>FFI code can be described in below steps:</p> <ul><li>Define FFI signatures.</li> <li>Construct FFI exchange.</li> <li>Perform FFI call.</li></ul> <p>We'll explain these three later. But let's see some solutions first.</p> <h2 id="solutions"><a href="#solutions" class="header-anchor">#</a> Solutions</h2> <h3 id="luajit-ffi"><a href="#luajit-ffi" class="header-anchor">#</a> LuaJit - FFI</h3> <p>The LuaJit FFI library allows calling external C functions and using C data structures from pure Lua code. It parses plain C declarations. The arguments passed to this function are automatically converted from Lua objects to the corresponding C types.</p> <p>Below is the <code>hello world</code> example.</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">local</span> ffi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;ffi&quot;</span><span class="token punctuation">)</span>

<span class="token comment">-- Define FFI signatures</span>
ffi<span class="token punctuation">.</span>cdef<span class="token string">[[
int printf(const char *fmt, ...);
]]</span>

<span class="token comment">-- Construct FFI exchange and Perform FFI call</span>
ffi<span class="token punctuation">.</span>C<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Hello %s!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><code>ffi.cdef</code> also supports defining c structs. LuaJit needs to remember the essential field names and field byte size for the function call.</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token comment">-- Guide LuaJit how to setup FFI exchange.</span>
ffi<span class="token punctuation">.</span>cdef<span class="token string">[[
typedef struct point point_t;
struct point {
  double x;
  double y;
};
]]</span>

<span class="token comment">-- Setup FFI exchange</span>
<span class="token keyword">local</span> points <span class="token operator">=</span> ffi<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;point_t[?]&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
points<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">1.0</span>
points<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">3.0</span>
</code></pre></div><h3 id="common-lisp-ffi"><a href="#common-lisp-ffi" class="header-anchor">#</a> Common Lisp - FFI</h3> <p>Common Lisp has CFFI, which stands for Common Foreign Function Interface.  In Common Lisp, we have something similar in LuaJit but in different looking feels.</p> <div class="language-lisp extra-class"><pre class="language-lisp"><code><span class="token heading comment title">;;; load cffi</span>
<span class="token punctuation">(</span><span class="token car">asdf</span><span class="token lisp-property property">:load-system</span> <span class="token lisp-property property">:cffi</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token car">defpackage</span> <span class="token lisp-property property">:cffi-user</span> <span class="token punctuation">(</span><span class="token lisp-property property">:use</span> <span class="token lisp-property property">:common-lisp</span> <span class="token lisp-property property">:cffi</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token heading comment title">;;; load the library</span>
<span class="token punctuation">(</span><span class="token car">define-foreign-library</span> libc
  <span class="token punctuation">(</span><span class="token boolean">t</span> <span class="token punctuation">(</span><span class="token lisp-property property">:default</span> <span class="token string">&quot;libc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token heading comment title">;;; use the library</span>
<span class="token punctuation">(</span><span class="token car">use-foreign-library</span> libc<span class="token punctuation">)</span>

<span class="token heading comment title">;;; define FFI signature</span>
<span class="token punctuation">(</span><span class="token car">defcfun</span> <span class="token string">&quot;printf&quot;</span> <span class="token lisp-property property">:int</span> <span class="token punctuation">(</span><span class="token car">str</span> <span class="token lisp-property property">:pointer</span><span class="token punctuation">)</span> &amp;rest<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token heading comment title">;;; construct FFI exchange and perform FFI call</span>
<span class="token punctuation">(</span><span class="token car">printf</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Everything expressed in Common Lisp is just in S-expression, even when you're writing CFFI bindings.</p> <h3 id="pony-ffi"><a href="#pony-ffi" class="header-anchor">#</a> Pony - FFI</h3> <p>In Pony, you can use FFI directly. The FFI call syntax is very much like a function call with little difference. Below example shows how to call a file write operation directly.</p> <div class="language- extra-class"><pre class="language-text"><code>@fwrite[U64](data.cstring(), U64(1), data.size(), _handle)
</code></pre></div><p>Calling FFI without predefined signatures looks convenient. Nonetheless, it's very dangerous. Without the signature, it might cause some potential bugs. And hence, it's still recommended defining signature first. Pony declare function signature via 'use' keyword.</p> <div class="language- extra-class"><pre class="language-text"><code>// define FFI signature
use @fwrite[U64](ptr: Pointer[U8] tag, size: U64, count: U64, stream: Pointer[U8] tag)

// construct FFI exchange and perform FFI call
@fwrite[U64](data.cstring(), U64(1), data.size(), _handle)
</code></pre></div><h3 id="c-libffi"><a href="#c-libffi" class="header-anchor">#</a> C - libffi</h3> <p>libffi a C library for FFI. Many VM languages written in C language use libffi to perform FFI calls.  Below code comes from <a href="https://www.chiark.greenend.org.uk/doc/libffi-dev/html/Simple-Example.html#Simple-Example" target="_blank" rel="noopener noreferrer">libffi simple example<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ffi.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  ffi_cif cif<span class="token punctuation">;</span>
  ffi_type <span class="token operator">*</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>values<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">;</span>
  ffi_arg rc<span class="token punctuation">;</span>
  
  <span class="token comment">/* Initialize the argument info vectors */</span>    
  args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>ffi_type_pointer<span class="token punctuation">;</span>
  values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">;</span>
  
  <span class="token comment">/* Initialize the cif */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ffi_prep_cif</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cif<span class="token punctuation">,</span> FFI_DEFAULT_ABI<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> 
               <span class="token operator">&amp;</span>ffi_type_sint<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">==</span> FFI_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      s <span class="token operator">=</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">;</span>
      <span class="token function">ffi_call</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cif<span class="token punctuation">,</span> puts<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rc<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/* rc now holds the result of the call to puts */</span>
      
      <span class="token comment">/* values hold a pointer to the function's arg, so to 
         call puts() again all we need to do is change the 
         value of s */</span>
      s <span class="token operator">=</span> <span class="token string">&quot;This is cool!&quot;</span><span class="token punctuation">;</span>
      <span class="token function">ffi_call</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cif<span class="token punctuation">,</span> puts<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rc<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>It has a set of <code>ffi_</code> prefixed functions. Especially, <code>ffi_prep_cif</code> is used to define signatures, <code>ffi_prep_cif_var</code> is used to define signatures for those varargs needed, <code>ffi_call</code> is for making calls.</p> <h2 id="patterns"><a href="#patterns" class="header-anchor">#</a> Patterns</h2> <h3 id="how-it-works"><a href="#how-it-works" class="header-anchor">#</a> How it works</h3> <p>FFI works by setting machine exchange information for you. Calling function has nothing special but does some simple but non-trivial register value moving. Once done, we extract return value from exchange information.</p> <h3 id="abi-v-s-api"><a href="#abi-v-s-api" class="header-anchor">#</a> ABI v/s API</h3> <p>ABI, or application binary interface, is on the contrary of API. It's a term describing communications between programs in machine level.</p> <p>FFI define function signatures by API, but it performs ABI calls.</p> <h3 id="type-conversion"><a href="#type-conversion" class="header-anchor">#</a> Type Conversion</h3> <p>VM languages usually have two extra things to do:</p> <ul><li>Before calling <code>ffi_call</code>, convert language types into FFI types.</li> <li>After calling <code>ffi_call</code>, convert FFI types back to language types.</li></ul> <p>We can easily find such tables in every language FFI implementation:</p> <table><thead><tr><th>ffi types</th> <th>language types</th></tr></thead> <tbody><tr><td>double,float</td> <td>number</td></tr> <tr><td>char *</td> <td>string</td></tr> <tr><td>book</td> <td>boolean</td></tr> <tr><td>struct</td> <td>class</td></tr> <tr><td>...</td> <td>...</td></tr></tbody></table> <p>Type conversion impacts performance but the impact is small considering below cases:</p> <ul><li>Very slow: implement everything in VM languages.</li> <li>Very fast: implement slow operations in C, and then make FFI calls in VM languages.</li> <li>Fastest: implement everything in C, or in assembly if you like. 😃</li></ul> <p>The example in <a href="https://luajit.org/ext_ffi.html" target="_blank" rel="noopener noreferrer">LuaJit FFI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> shows LuaJit FFI call is 110x faster than in pure Lua interpreter.</p> <h3 id="c-headers-copy-n-paste-v-s-semantic-signature"><a href="#c-headers-copy-n-paste-v-s-semantic-signature" class="header-anchor">#</a> C Headers Copy-n-Paste v/s Semantic Signature</h3> <p>LuaJit and Python support copy-n-pasting C header file when defining function signatures. It's easy to use for users, cause the header file is very easy to find from library source code. The downside is that it needs to parse C code in runtime.</p> <p>Ruby and Common Lisp use semantic signatures, that is to explicitly define function name, argument types, and return type. Basically, copy-n-pasting can be built on top of semantic signature.</p> <p>Pony and Rust allow defining signatures in their language code. They compile code anyway, so the language compilers help you do the dirty work. It makes code styling more unified.</p> <h3 id="alignment-in-32-bit-v-s-64-bit"><a href="#alignment-in-32-bit-v-s-64-bit" class="header-anchor">#</a> !!! Alignment in 32-bit v/s 64-bit</h3> <p>We need the size of values, otherwise, we'll get a different binary sequence. Without getting data aligned, the library will get the wrong data and thus lead the application crash.</p> <p>For example, in a 32-bit platform, a pointer has 4 bytes; while in a 64-bit platform, a pointer has 8 bytes. Below comparison shows the same pointer value has different results generated when passing to the dynamic library.</p> <div class="language- extra-class"><pre class="language-text"><code># in 32-bit
0x00000000111111110000000011111111

# in 64-bit
0x0000000011111111000000001111111100000000111111110000000011111111
</code></pre></div><p>It's also essential to align some insufficient values to minimum size. For example, if a value has 6 bytes size in a 64-bit platform, we need to add zero padding so that it has a minimum of 8 bytes.</p> <h3 id="long-long"><a href="#long-long" class="header-anchor">#</a> Long Long</h3> <p>Not every platform support types like <code>long long</code>.  FFI libraries might need to implement that internally. When using the FFI library, watch out if you can use this feature.</p> <h3 id="callback"><a href="#callback" class="header-anchor">#</a> Callback</h3> <p>In C code, we often write Function Pointers. For example, in libuv, we have below definitions:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>uv_walk_cb<span class="token punctuation">)</span><span class="token punctuation">(</span>uv_handle_t<span class="token operator">*</span> handle<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">uv_walk</span><span class="token punctuation">(</span>uv_loop_t<span class="token operator">*</span> loop<span class="token punctuation">,</span> uv_walk_cb walk_cb<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>It's essential to have a way to map VM functions into FFI functions. Luckily, we have <a href="https://www.chiark.greenend.org.uk/doc/libffi-dev/html/The-Closure-API.html#The-Closure-API" target="_blank" rel="noopener noreferrer">ffi_closure<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to achieve that. It enables arbitrary functions to be passed into an FFI call. You need to do below things:</p> <ul><li>allocate memory for ffi_closure</li> <li>set a ffi_closure pointer into the exchange.</li> <li>free memory for ffi_closure</li></ul> <h3 id="garbage-collect"><a href="#garbage-collect" class="header-anchor">#</a> Garbage Collect</h3> <p>You don't need to care about memory management due to GC is usually built-in in VM language. However, when writing FFI calls, you need to worry about low-level memory management problem.</p> <p>There is no C stack in FFI. All data live either in the native heap or VM-managed heap. Free those useless when becomes useless.</p> <h3 id="thread-safe-v-s-thread-unsafe"><a href="#thread-safe-v-s-thread-unsafe" class="header-anchor">#</a> Thread-safe v/s Thread-unsafe</h3> <p>Some C operations are not thread-safe. Be careful when calling them when you're writing concurrency.</p> <h3 id="advantage-and-disadvantage"><a href="#advantage-and-disadvantage" class="header-anchor">#</a> Advantage and Disadvantage</h3> <ul><li>Advantage
<ul><li>Very good performance, as long as your C code not sucks.</li> <li>Reuse whatsoever in-place in the system.</li> <li>Easily port C library to another VM language. For example, <a href="https://www.imagemagick.org/script/api.php" target="_blank" rel="noopener noreferrer">ImageMagick<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> can be integrated into almost every VM language via FFI without changing C code.</li></ul></li> <li>Disadvantage
<ul><li>Introduce system dependency.</li> <li>Portability. Some interfaces might not work in another platform or architect. For example, you can't use Windows <code>MessageBoxA</code> in Linux.</li></ul></li></ul> <h2 id="conclusions"><a href="#conclusions" class="header-anchor">#</a> Conclusions</h2> <p>If you have performance bottleneck when running the CPU-intensive calculation in VM language, and ALSO feels VM interpreter runs so slow, take a look at FFI! If you want to write your own interpreter language, also try to integrate libffi as a bonus!</p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ul><li><a href="https://eli.thegreenplace.net/2013/03/04/flexible-runtime-interface-to-shared-libraries-with-libffi" target="_blank" rel="noopener noreferrer">Flexible runtime interface to shared libraries with libffi<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/ffi/ffi/wiki/Why-use-FFI" target="_blank" rel="noopener noreferrer">Why use FFI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://luajit.org/ext_ffi.html" target="_blank" rel="noopener noreferrer">LuaJit - FFI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://cffi.readthedocs.io/en/latest/overview.html" target="_blank" rel="noopener noreferrer">Python - CFFI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.chiark.greenend.org.uk/doc/libffi-dev/html/Using-libffi.html#Using-libffi" target="_blank" rel="noopener noreferrer">Using LibFFI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://stackoverflow.com/questions/5963266/call-c-function-from-java" target="_blank" rel="noopener noreferrer">Java JNI example<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://tutorial.ponylang.org/c-ffi/" target="_blank" rel="noopener noreferrer">Pony - FFI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://doc.rust-lang.org/book/first-edition/ffi.html" target="_blank" rel="noopener noreferrer">Rust - FFI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://common-lisp.net/project/cffi/manual/cffi-manual.html" target="_blank" rel="noopener noreferrer">CommonLisp - FFI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://gist.github.com/soasme/1ddbf4de79e341cbf2e0cf7357a166f7" target="_blank" rel="noopener noreferrer">Example of source code in this post<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://techbrahmana.blogspot.com/2008/08/how-libffi-actually-works.html" target="_blank" rel="noopener noreferrer">How libffi actually works?<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/soasme/enqueuezero/edit/master/concepts/ffi.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.26662bcd.js" defer></script><script src="/assets/js/6.d2240214.js" defer></script><script src="/assets/js/89.2b92f963.js" defer></script>
  </body>
</html>
